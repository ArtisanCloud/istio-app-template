{{- $root := . -}}
{{- $fullName := include "istio-app.fullname" . -}}

{{- if .Values.visualService.enable -}}
# 路由规则
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ $fullName }}
spec:
  host: {{ $fullName }}
  subsets:
  {{- range $i, $item := .Values.app }}
  - name: {{ .name }}
    labels:
      version: {{ .version }}
  {{- end }}
---
{{- end -}}

apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "istio-app.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "istio-app.selectorLabels" . | nindent 4 }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $fullName }}

{{- if .Values.visualService.enable -}}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullName }}
spec:
  hosts: 
    {{ toYaml .Values.visualService.hosts | nindent 4 }}
  gateways:
    {{ toYaml .Values.visualService.gateway }}
  http:
  - match:
    - uri:
        prefix: /
    route:
    {{- range $i, $item := .Values.app }}
    - destination:
        port:
          number: {{ $root.Values.service.port }} # 这个端口和Service里面的端口一致就行。
        host: {{ $fullName }} # 指向的应用
        subset: {{ .name }}
      weight: {{ .weight }}
    {{- end }}
{{- end -}}